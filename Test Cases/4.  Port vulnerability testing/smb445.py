from impacket.smbconnection import SMBConnection
import socket
import json

def is_port_open(ip, port=445):
    try:
        socket.create_connection((ip, port), timeout=2)
        return True
    except:
        return False

def check_smb_vulnerability(ip, port=445):
    if not is_port_open(ip, port):
        print("Port 445 is not open or reachable.")
        return False

    # Load credentials from JSON
    try:
        with open("credentials.json", "r") as file:
            credentials = json.load(file)
    except Exception as e:
        print("Failed to load credentials.json: " + str(e))
        return False

    print("Scanning smb://" + ip + ":" + str(port) + " for SMB login vulnerabilities...")

    for entry in credentials:
        username = entry["username"]
        password = entry["password"]

        try:
            smb = SMBConnection(ip, ip, sess_port=port, timeout=3)
            smb.login(username, password)
            print("Access granted with " + username + " / " + password)
            print("SMB (port 445) is vulnerable.")
            smb.close()
            return True
        except Exception as e:
            print("Failed for " + username + ": " + str(e))

    print("SMB (port 445) is not vulnerable with given credentials.")
    return False

if __name__ == "__main__":
    target_ip = input("Enter target IP: ").strip()
    check_smb_vulnerability(target_ip)
