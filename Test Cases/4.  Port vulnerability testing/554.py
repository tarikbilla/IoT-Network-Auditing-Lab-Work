import socket
import base64
import json

def load_credentials(json_path):
    with open(json_path, 'r') as f:
        return json.load(f)

def is_rtsp_open(ip, port):
    try:
        with socket.create_connection((ip, port), timeout=3) as sock:
            print(f"Port {port} open on {ip}")
            return True
    except Exception:
        print(f"Port {port} closed on {ip}")
        return False

def send_rtsp_request(ip, port, user=None, password=None):
    try:
        s = socket.create_connection((ip, port), timeout=5)
        headers = (
            f"OPTIONS rtsp://{ip}:{port}/ RTSP/1.0\r\n"
            "CSeq: 1\r\n"
        )
        if user and password:
            auth = base64.b64encode(f"{user}:{password}".encode()).decode()
            headers += f"Authorization: Basic {auth}\r\n"
        headers += "\r\n"

        s.send(headers.encode())
        response = s.recv(2048).decode(errors="ignore")
        s.close()
        return response
    except Exception as e:
        return ""

def check_rtsp_vulnerability(ip, port, credentials_list):
    response = send_rtsp_request(ip, port)
    if "200 OK" in response:
        print("RTSP access is open without authentication")
        return
    elif "401 Unauthorized" in response:
        print("Authentication required. Checking credentials...")
        for cred in credentials_list:
            user = cred.get("username")
            password = cred.get("password")
            response = send_rtsp_request(ip, port, user, password)
            if "200 OK" in response:
                print(f"Valid credentials found {user}:{password}")
                return
        print("No valid credentials found. RTSP access protected")
    else:
        print("RTSP service not detected or unexpected response")

def main():
    ip = input("Enter target IP: ").strip()
    port = input("Enter target port (default 554): ").strip()
    port = int(port) if port else 554

    credentials_file = "credentials.json"  # Use your uploaded file
    credentials = load_credentials(credentials_file)

    print(f"Scanning {ip} on port {port}")
    if is_rtsp_open(ip, port):
        check_rtsp_vulnerability(ip, port, credentials)

if __name__ == "__main__":
    main()
